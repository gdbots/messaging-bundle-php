{#
  Require libraries:
    - http://momentjs.com/
    - http://www.daterangepicker.com/

  fixme: this generates a massive prototype in a div attribute, could be made simpler
  fixme: a date doesn't need utc conversion and must always be YYYY-MM-DD
#}

<script type="text/javascript">
  var wbq = wbq || [];
  wbq.push(function initDateRangePicker_{{ widgetId }}() {
    require(
    [
      'jquery',
      'moment',
      'daterangepicker'
    ],
    function ($, moment) {
      'use strict';

      var $datepicker = $('#{{ widgetId }}');

      $datepicker.change(function () {
        var $picker = $(this);
        if (!$picker.data('daterangepicker') || '' === $picker.val()) {
          return;
        }

        if ('{{ widgetType }}' == 'date') {
          $picker.val(moment($picker.data('daterangepicker').startDate).format('YYYY-MM-DD'));
        } else {
          $picker.val(moment($picker.data('daterangepicker').startDate).utc().format('YYYY-MM-DDTHH:mm:ss.SSSSSS') + 'Z');
        }
      });

      $datepicker.click(function () {
        var $picker = $(this);
        if ($picker.data('daterangepicker')) {
          return;
        }

        $picker.daterangepicker(
          $.extend(true, {{ options|default([])|json_encode|raw }}, {
            'startDate': '' !== $picker.val() ? moment.utc($picker.val()).local() : moment()
          }),
          {{ callback|default('function(){}')|raw }}
        );

        $picker.click();
      });
    });
  });
</script>
