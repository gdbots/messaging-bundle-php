{% use 'bootstrap_3_layout.html.twig' %}

{# Rows #}

{% block gdbots_pbjx_date_picker_row -%}
  {% if widget == 'single_text' %}
    <div class="form-group{% if force_error|default(false) and not valid %} has-error{% endif %}">
      {{- form_label(form) -}}
      <div class="input-group">
        <div class="input-group-addon"><i class="icon-calendar22"></i></div>
        {{- form_widget(form) -}}
        <div class="input-group-btn">
          <button type="button" class="btn btn-default js-clear-btn" data-target="#{{ form.vars.id }}" title="Clear Date"><i class="icon-cross2"></i></button>
        </div>
      </div>
      {{- form_errors(form) -}}
    </div>
  {% else %}
    {{ block('date_row') }}
  {% endif %}
{%- endblock gdbots_pbjx_date_picker_row %}

{% block gdbots_pbjx_datetime_picker_row -%}
  {% if widget == 'single_text' %}
    <div class="form-group{% if force_error|default(false) and not valid %} has-error{% endif %}">
      {{- form_label(form) -}}
      <div class="input-group">
        <div class="input-group-addon"><i class="icon-calendar22"></i></div>
        {{- form_widget(form) -}}
        <div class="input-group-btn">
          <button type="button" class="btn btn-default js-clear-btn" data-target="#{{ form.vars.id }}" title="Clear Date"><i class="icon-cross2"></i></button>
        </div>
      </div>
      {{- form_errors(form) -}}
    </div>
  {% else %}
    {{ block('datetime_row') }}
  {% endif %}
{%- endblock gdbots_pbjx_datetime_picker_row %}

{# Widgets #}

{% block gdbots_pbjx_collection_widget -%}
  {% if prototype is defined %}
    {% set prototype_html = _self.gdbots_pbjx_collection_item_prototype(form) %}
  {% endif %}

  {% set id = id ~ '_collection' %}
  {% set prototype_name = form.vars.prototype_name %}

  <div class="row-collection">
    <div {{ block('widget_container_attributes') }}
      data-last-index="{{ form.children|length}}"
      data-row-count-add="{{ form.vars.row_count_add }}"
      data-prototype-name="{{ prototype_name }}"
      {% if prototype_html is defined %}
        data-prototype="{{ prototype_html|escape }}"
      {% endif %}
    >
      {% if form.children|length %}
        {% for child in form.children %}
          {{ _self.gdbots_pbjx_collection_item_prototype(child) }}
        {% endfor %}
      {% elseif show_form_when_empty and prototype_html is defined %}
        {% for i in 0..(form.vars.row_count_initial - 1) %}
          {{ prototype_html|replace({(prototype_name): i})|raw }}
        {% endfor %}
      {% endif %}
    </div>

    {% if allow_add %}
      <button class="btn btn-action js-btn-add-collection-item" type="button">+ Add</button>
    {% endif %}
  </div>
{% endblock gdbots_pbjx_collection_widget -%}

{% block gdbots_pbjx_dynamic_field_widget -%}
  <div class="row">
    <div class="col-md-5">
      {{- form_widget(form.name, {'attr': {
        'class': 'input-sm',
        'placeholder': 'Name'
      }}) -}}
    </div>
    <div class="col-md-2">
      {{- form_widget(form.kind, {'attr': {
        'class': 'input-sm'
      }}) -}}
    </div>
    <div class="col-md-5">
      {{- form_widget(form.value, {'attr': {
        'class': 'input-sm',
        'placeholder': 'Value'
      }}) -}}
    </div>
  </div>
{%- endblock gdbots_pbjx_dynamic_field_widget %}

{% block gdbots_pbjx_geo_point_widget -%}
  <div class="row">
    <div class="col-md-6">
      {{- form_widget(form.latitude, {'attr': {
        'class': 'input-sm',
        'placeholder': 'Latitude'
      }}) -}}
    </div>
    <div class="col-md-6">
      {{- form_widget(form.longitude, {'attr': {
        'class': 'input-sm',
        'placeholder': 'Longitude'
      }}) -}}
    </div>
  </div>
{%- endblock gdbots_pbjx_geo_point_widget %}

{% block gdbots_pbjx_date_picker_widget -%}
  {% if widget == 'single_text' %}
    {%- set attr = attr|merge({
      'class': (attr.class|default('') ~ ' js-datepicker')|trim,
      'placeholder': attr.placeholder|default('Click to select a date.'),
      'readonly': attr.readonly|default(true),
    }) -%}

    {{ _self.daterangepicker_js(form) }}
  {% endif %}

  {{ block('date_widget') }}
{%- endblock gdbots_pbjx_date_picker_widget %}

{% block gdbots_pbjx_datetime_picker_widget -%}
  {% if widget == 'single_text' %}
    {%- set attr = attr|merge({
      'class': (attr.class|default('') ~ ' js-datepicker')|trim,
      'placeholder': attr.placeholder|default('Click to select a date.'),
      'readonly': attr.readonly|default(true)
    }) -%}

    {{ _self.daterangepicker_js(form) }}
  {% endif %}

  {{ block('datetime_widget') }}
{%- endblock gdbots_pbjx_datetime_picker_widget %}

{# Macro #}

{% macro gdbots_pbjx_collection_item_prototype(widget) %}
  {% if 'collection' in widget.vars.block_prefixes %}
    {% set form = widget.vars.prototype %}
    {% set name = widget.vars.prototype.vars.name %}
    {% set disabled = widget.vars.disabled %}
    {% set allow_delete = widget.vars.allow_delete %}
  {% else %}
    {% set form = widget %}
    {% set name = widget.vars.full_name %}
    {% set disabled = widget.parent.vars.disabled %}
    {% set allow_delete = widget.parent.vars.allow_delete %}
    {% if widget.vars.allow_delete is defined %}
      {% set allow_delete = allow_delete and widget.vars.allow_delete %}
    {% endif %}
  {% endif %}

  <div data-content="{{ name }}">
    <div class="row {% if not allow_delete %} not-removable{% endif %}">
      <div class="col-md-{% if allow_delete %}11{% else %}12{% endif %}">
        {{ form_widget(form, {disabled: disabled}) }}
      </div>

      {% if allow_delete %}
        <div class="col-md-1">
          <button class="btn btn-action btn-link js-btn-remove-collection-item" type="button" data-related="{{ name }}">Ã—</button>
        </div>
      {% endif %}
    </div>
  </div>
{% endmacro gdbots_pbjx_collection_item_prototype %}

{% macro daterangepicker_js(widget) -%}
  <script type="text/javascript">
    var wbq = wbq || [];
    wbq.push(function initDateRangePicker_{{ widget.vars.id }}() {
      require(['jquery', 'moment', 'daterangepicker'], function ($, moment) {
        'use strict';

        var $datepicker = $('#{{ widget.vars.id }}');

        $datepicker.change(function () {
          var $picker = $(this);
          if (!$picker.data('daterangepicker') || '' === $picker.val()) {
            return;
          }

          {% if widget.vars.type|default('datetime') == 'date' %}
            $picker.val(moment($picker.data('daterangepicker').startDate).utc().format('YYYY-MM-DD'));
          {% else %}
            $picker.val(moment($picker.data('daterangepicker').startDate).utc().format('YYYY-MM-DDTHH:mm:ss.SSSSSS') + 'Z');
          {% endif %}
        });

        $datepicker.click(function () {
          var $picker = $(this);
          if ($picker.data('daterangepicker')) {
            return;
          }

          $picker.daterangepicker(
            $.extend(true, {{ widget.vars.js_options|default('{}')|json_encode|raw }}, {
              'startDate': '' !== $picker.val() ? moment.utc($picker.val()).local() : moment()
            })
            {% if widget.vars.js_callback is defined %}
              , {{ widget.vars.js_callback|raw }}
            {% endif %}
          );

          $picker.click();
        });
      });
    });
  </script>
{%- endmacro daterangepicker_js %}
